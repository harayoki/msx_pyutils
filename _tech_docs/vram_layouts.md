# MSX VRAM構成とパレット設定

## SCREEN 2 (MSX1)
- 解像度: 256×192、固定16色パレット（変更不可）
- 各テーブルはデフォルトで以下に配置される。VDP レジスタである程度変更が可能。

| 用途 | アドレス範囲 | 備考 |
| --- | --- | --- |
| パターンジェネレータ | `0000h–17FFh` | 8×8 ドット×768パターン（3バンク） |
| ネームテーブル | `1800h–1AFFh` | 32×24=768 バイト、画面に配置するパターン番号 |
| スプライト属性 | `1B00h–1B7Fh` | 32個分。Y=216(0xD8)で終端 |
| カラーテーブル | `2000h–37FFh` | 8×8×768 バイト、パターンジェネレータに対応する色データ |
| スプライトパターン | `3800h–3FFFh` | 8×8×256 バイト |

## SCREEN 4 (Graphic 3, MSX2以降)
- 解像度: 256×192、色数は SCREEN 2 と同じ 2bpp × パターンカラー。
- SCREEN 2 と互換だが、テーブル開始アドレスが異なりスプライトは **タイプ2**（多色スプライト）。
- 初期化直後の VRAM マップ（1ページ分）は以下のとおり。

| 用途 | アドレス範囲 | 備考 |
| --- | --- | --- |
| パターンジェネレータ | `00000h–017FFh` | 8×8 ドット×768パターン（3バンク） |
| ネームテーブル | `01800h–01AFFh` | 32×24=768 バイト |
| カラーパレットテーブル | `01B80h–01B9Fh` | 16色×2バイト（各 R/G/B 3bit） |
| スプライト色 | `01C00h–01DFFh` | 256エントリ（各1バイト） |
| スプライト属性 | `01E00h–01E7Fh` | 32個分。Y=216(0xD8)で終端 |
| パターンカラー | `02000h–037FFh` | 8×8×768 バイト、パターンジェネレータに対応する色データ |
| スプライトパターン | `03800h–03FFFh` | 8×8×256 バイト |
| 空き | `04000h–0FFFFh/1FFFFh` | VRAM 64KB/128KB により変動 |

- VDP 設定の要点: R#1 の M4=1 で SCREEN 4 を選択。R#2/3/4/10 で各テーブル先頭アドレスが決まる（初期値は R#2=06h, R#3=FFh, R#10=00h, R#4=03h）。

## MSX2以降のグラフィックモード概要
各 SCREEN は VRAM をページ単位で使い、ページ番号は `SET PAGE [表示],[描画]` で切替えられる。
MSX2 以降のグラフィックモードは、**画面表示が 212 ラインであっても VRAM 上では常に 256 ライン分の領域が確保される。**

- **SCREEN 5 (Graphic 4)**  
  - 解像度: 256×212  
  - 表示形式: 4bpp（1バイトに2ドット）  
  - VRAM: 1行128バイト（内部は 256 行分存在）  
  - **1ページ = 0x6A00 バイト（26880バイト）**

- **SCREEN 7 (Graphic 6)**  
  - 解像度: 512×212  
  - 表示形式: 4bpp（1バイトに2ドット）  
  - VRAM: 1行256バイト（内部は 256 行分存在）  
  - **1ページ = 0xD400 バイト（54272バイト）**

- **SCREEN 8 (Graphic 7)**  
  - 解像度: 256×212  
  - 表示形式: 8bpp（1バイト1ドット）  
  - VRAM: 1行256バイト（内部は 256 行分存在）  
  - **1ページ = 0xD800 バイト（55296バイト）**

- **SCREEN 12 (YJK)**  
  - 解像度: 256×212  
  - 表示形式: YJK（パレット併用なし）  
  - VRAM: 1行256バイト（内部は 256 行分存在）  
  - **1ページ = 0xD800 バイト（55296バイト）**

## BASICでのパレット設定
- **MSX1 (TMS9918A)**: パレットは固定。`COLOR` は前景・背景のインデックス指定のみで RGB 変更は不可。
- **MSX2 (V9938)**: `COLOR=(カラー番号,R,G,B)` で 0–15 番のパレットを 3bit RGB (各 0–7) で設定可能。前景/背景/ボーダー/スクリーンカラーの指定は `COLOR fore,back,border`。
  ```basic
  SCREEN 5: COLOR 15,0,0      '使用色の指定（パレット番号）
  COLOR=(15,7,7,7)            'パレット番号15を白へ（MSX2の最大値は7）
  COLOR 15,4,4                '前景・背景・ボーダー色の割り当て
  ```

### SCREEN 12 の YJK 格納方式と RGB 変換
- 1 ピクセル 1 バイト。ビット 0–4 が輝度成分 Y (0–31)。
- 横方向 4 ピクセル単位で J/K が共有され、各バイトのビット5が J、ビット6が K のビットとして 4 つ分集められる。
  - 4 ピクセルのうち X=0 のビットが J/K の下位ビット、X=3 のビットが上位ビットになる（ビット 0 が最下位、ビット 3 が最上位）。
  - `Jbits = b0[5] + b1[5]<<1 + b2[5]<<2 + b3[5]<<3` のように 4bit 値を組み立て、`J = Jbits` が 8 以上なら 16 を引いて符号付き (-8〜+7) として扱う（K も同様）。
  - 4bit 値として符号付き (-8〜+7) とみなし、J/K を復元する。ビット7は SCREEN 12 では未使用。
- 復元した Y/J/K から RGB を求める例（各値は 0–31 にクランプ）：
  - `R = clamp(Y + J)`
  - `G = clamp(Y + K)`
  - `B = clamp(Y - J - K)`
- 5bit RGB を 8bit 相当に直す場合は `value * 255 / 31` でスケールする。

#### RGB から YJK への変換概要
- 目標の 5bit RGB (0–31) から Y/J/K を作る場合の一例:
  - `Y = clamp((R + G + B) / 3)`
  - `J = clamp(R - B)`
  - `K = clamp(G - B)`
- 4 ドット単位で J と K を 4bit にパックし、各ドットの Y は 5bit のまま格納する。J/K は -8〜+7 に収める必要があるので、事前にクランプしてから 4bit の符号付き値
  (`+8` を足して 0–15) に直し、各ドットのビット位置に配置する。
- RGB→YJK は可逆ではないため、明度・彩度が高い色ほど J/K の符号付き 4bit 制約で色ずれが起こりやすい点に注意。

## マシン語でのパレット設定（SUB-ROM）
- SETPLET (SUB-ROM 014Dh) を呼び出すと、MSX2 以降でパレットを変更できる。
- SUB-ROM 呼び出しのエントリポイントは 015Ch（SUBROM）。
- レジスタ指定（SETPLET 呼び出し時）
  - D = COLOR番号（0〜15）
  - A = 上位4bit = 赤(0〜7)、下位4bit = 青(0〜7)
  - E = 緑(0〜7)

```asm
; 例: 色7を R=7, G=3, B=5 にする。SCREEN5/7前提。
SetCol7:
    ld  d,7              ; COLOR 7
    ld  a,(7 << 4) + 5   ; R=7, B=5 → A = %0111_0101
    ld  e,3              ; G=3

    ld  ix,014Dh         ; SUB-ROM: SETPLET
    call 015Ch           ; SUBROM
    ret
```
- CHGMOD (SUB-ROM 00D1h) で SCREEN を切り替えるとパレットが初期化されるので、必要に応じて再設定する。
- カートリッジROMから呼び出す場合は、事前に SUB-ROM スロットを IY にセットする CALSLT パターンを使う。

### 背景色・周辺色のマシン語設定
- 前景/背景/ボーダー色は BIOS のシステム変数 (FORCLR=F3E9h / BAKCLR=F3EAh / BDRCLR=F3EBh) に書き込んだうえで `CHGCLR` (0062h) を呼ぶと反映される。各値は 0〜15 のパレット番号。

```asm
    ld   a,15         ; 前景色 (COLOR の第1引数)
    ld   (0F3E9h),a
    ld   a,4          ; 背景色 (COLOR の第2引数)
    ld   (0F3EAh),a
    ld   a,4          ; ボーダー色 (COLOR の第3引数)
    ld   (0F3EBh),a
    call 0062h        ; BIOS: CHGCLR で VDP レジスタへ反映
```
