# MSX1 VDPの読み書き操作メモ

MSX1のVDP（TMS9918A/TMS9928A/TMS9929A互換）はZ80からI/Oポート経由で操作する。ここではVRAM/レジスタ/ステータスの読み書きを、マシン語（Z80アセンブリ）例とともにまとめる。

## VDPポート一覧
| ポート | 方向 | 主な用途 | 備考 |
| --- | --- | --- | --- |
| #98h | 読み/書き | VRAMデータ転送 | アクセス毎にVRAMアドレスが自動インクリメントされる |
| #99h | 書き | VRAMアドレス設定、VDPレジスタ設定 | 下位バイト→上位バイト+コマンドの順で2バイト送る |
| #99h | 読み | ステータスレジスタ読み出し | S#0読み出しで割り込みフラグがクリアされる |

## 基本ポート
- ポート#98h: VRAMデータポート。VRAMの読み書き時に利用し、アクセス後はアドレスが自動でインクリメントされる。
- ポート#99h: 制御ポート。VRAMアクセスアドレスの設定、VDPレジスタ書き込み、ステータスレジスタ読み取りに用いる。

## コマンドバイトの構造（制御ポート #99h に送出）
制御ポートへは必ず **下位アドレス → 上位アドレス+コマンド** の順で2バイト連続書き込みを行う。

```
1バイト目: VRAMアドレス下位8bit (A0-A7)
2バイト目: A14-A8 (上位7bit) と C1-C0 (コマンド)
            bit7 bit6 bit5 bit4 bit3 bit2 bit1 bit0
            A14  A13  A12  A11  A10  A9   A8   C1  C0
```

- C1C0=00: VRAM読出しアドレス設定（以後#98hから読出し）
- C1C0=01: VRAM書込アドレス設定（以後#98hへ書込）
- C1C0=10: VDPレジスタ設定（A4-A0がレジスタ番号となり、先に#99hへデータを書いた後にこのコマンドバイトを送る）
- C1C0=11: 未使用

> MSX1のVRAMアドレスは14bit（0x0000-0x3FFF）。A14は常に0として扱われる。

## VRAM書き込み
連続転送では1回アドレスをセットした後、ポート#98hへデータを流し込むだけで自動インクリメントされる。

```asm
; HL = VRAM開始アドレス, DE = 転送元RAM, BC = バイト数
; 破壊: AF,BC,DE,HL
VDP_VRAM_WRITE:
    ld a,l           ; 1: アドレス下位
    out (#99),a
    ld a,h
    or 01000000b     ; 2: 上位 + C1C0=01 (VRAM書込)
    out (#99),a
WRITE_LOOP:
    ld a,(de)
    out (#98),a      ; 3: データ書込（アドレスが自動加算）
    inc de
    dec bc
    ld a,b
    or c
    jr nz,WRITE_LOOP
    ret
```

## VRAM読出し
読出しではアドレス設定後、最初の1バイトはプリフェッチのため無効になる点に注意する。

```asm
; HL = VRAM開始アドレス, DE = 転送先RAM, BC = バイト数
; 破壊: AF,BC,DE,HL
VDP_VRAM_READ:
    ld a,l           ; 1: アドレス下位
    out (#99),a
    ld a,h           ; 2: 上位 + C1C0=00 (VRAM読込)
    and 00111111b    ; A14は0、bit7=0で読込指定
    out (#99),a
    in a,(#98)       ; 3: ダミーリード（プリフェッチ）
READ_LOOP:
    in a,(#98)       ; 4: 実データ取得
    ld (de),a
    inc de
    dec bc
    ld a,b
    or c
    jr nz,READ_LOOP
    ret
```

## VDPレジスタ書き込み
レジスタ番号は0–7（MSX1）。データを書いてからコマンドバイトを送る点に注意。

```asm
; B = レジスタ番号 (0-7), C = 設定値
; 破壊: AF
VDP_REG_WRITE:
    ld a,c
    out (#99),a              ; 1: レジスタへ書くデータ
    ld a,b
    or 10000000b             ; 2: C1C0=10 をセット
    out (#99),a
    ret
```

## ステータスレジスタ読出し
ステータス0（S#0）を読むだけで割り込みフラグなどがクリアされる。

```asm
; B = 読みたいステータス番号(0-1) ※MSX1はS#0とS#1のみ
; 戻り: A = ステータス値
; 破壊: AF
VDP_STATUS_READ:
    ld a,b
    out (#99),a      ; ステータス番号を上位5bitに入れて送る必要はなく、MSX1はB=0固定で良い場合が多い
    in a,(#99)       ; 読み出し
    ret
```

## ポートアクセスの機械語バイト列例
小さなパッチを作る際、上記手順をそのままバイト列で埋め込む場合の目安。

- VRAM書込アドレス設定（HLに0x2000と仮定）
  - `2A 00 20` ; `ld hl,2000h`
  - `7D D3 99` ; `ld a,l` / `out (99h),a`
  - `7C F6 40 D3 99` ; `ld a,h` / `or 40h` / `out (99h),a`
- VRAM読込プリフェッチ付き
  - `7D D3 99` ; `ld a,l` / `out (99h),a`
  - `7C E6 3F D3 99` ; `ld a,h` / `and 3Fh` / `out (99h),a`
  - `DB 98` ; `in a,(98h)` ダミー
- VDPレジスタ1へ0xE0を書込む例
  - `3E E0 D3 99` ; データ送信
  - `06 01 F6 80 D3 99` ; `ld b,1` / `or 80h` / `out (99h),a`

用途に応じて上記の骨格を展開し、必要なループや保存レジスタ処理を追加すること。
