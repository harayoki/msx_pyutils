# MSX ROMマッパーの概要

MSX向けROMカートリッジの代表的なマッパーと切り替え手順をまとめる。ここではASCII 8k/16kと、コナミのメガロムマッパーの使い方を中心に、その他形式の概要を示す。

## ASCII 8k / ASCII 16k マッパー

### 共通の前提
- 切り替えレジスタはCPUから直接書き込むだけで反映される。
- バンク番号は8bitで指定し、上位ビットはハードウェアで無視される場合がある。
- 初期状態では最下位バンク(0, 1…)が順にページへ割り当てられていることが多い。

### ASCII 8k
- ページサイズ: 8 KiB。
- バンク選択レジスタ:
  | ページ | アドレス帯 (書込) | 有効範囲 |
  | --- | --- | --- |
  | 0x4000–0x5FFF | 0x6000–0x67FF | 8 KiBバンク番号 |
  | 0x6000–0x7FFF | 0x6800–0x6FFF | 8 KiBバンク番号 |
  | 0x8000–0x9FFF | 0x7000–0x77FF | 8 KiBバンク番号 |
  | 0xA000–0xBFFF | 0x7800–0x7FFF | 8 KiBバンク番号 |
- 使い方の流れ:
  1. 必要なページに対応するレジスタへバンク番号を書き込む。
  2. 即座に指定バンクが該当ページへ反映されるので、以降は普通にコード/データを実行・読み出しできる。
  3. 連続アクセスする際は、切り替え直後にジャンプ先を用意するか、自己書き換え/スロットワークを利用して安全に制御する。

### ASCII 16k
- ページサイズ: 16 KiB。
- バンク選択レジスタ:
  | ページ | アドレス帯 (書込) | 有効範囲 |
  | --- | --- | --- |
  | 0x4000–0x7FFF | 0x6000–0x67FF | 16 KiBバンク番号 |
  | 0x8000–0xBFFF | 0x7000–0x77FF | 16 KiBバンク番号 |
- 使い方の流れはASCII 8kと同じ。16 KiB単位で扱うため、データ配置時は境界を揃えておくと扱いやすい。

## コナミ系メガロムマッパー

### KONAMI (SCCなし)
- ページサイズ: 8 KiB。
- バンク選択レジスタ:
  | ページ | アドレス帯 (書込) | 備考 |
  | --- | --- | --- |
  | 0x4000–0x5FFF | 0x6000 | 8 KiBバンク番号 |
  | 0x6000–0x7FFF | 0x8000 | 8 KiBバンク番号 |
  | 0x8000–0x9FFF | 0xA000 | 8 KiBバンク番号 |
  | 0xA000–0xBFFF | 0xC000 | 8 KiBバンク番号 |
- 典型的な使用手順:
  1. 実行中のページとは別のページのレジスタに書き込んでからジャンプ/データ参照する。
  2. バンク番号は通常0から順にROMを割り当てる。リセット直後は下位バンクが先頭ページに割り当てられている。

### KONAMI SCC (SCC付き)
- ページサイズ: 8 KiB。
- バンク選択レジスタとSCC有効化:
  | ページ | アドレス帯 (書込) | 備考 |
  | --- | --- | --- |
  | 0x4000–0x5FFF | 0x5000 | 8 KiBバンク番号 |
  | 0x6000–0x7FFF | 0x7000 | 8 KiBバンク番号 |
  | 0x8000–0x9FFF | 0x9000 | 8 KiBバンク番号。バンク番号を0x3Fにすると0x9800–0x9FFFがSCCレジスタとして有効化される。 |
  | 0xA000–0xBFFF | 0xB000 | 8 KiBバンク番号 |
- 使い方のポイント:
  - SCC音源を使わない場合は通常のバンク切替だけでよい。
  - SCCを使う場合、0x9000に0x3Fを書いてSCCをページ3に出現させ、0xB000側でSCCの波形テーブルや音量レジスタへアクセスするのが一般的。
  - SCC有効化後に再び別のバンク番号を書けばROMデータを戻せる。

## その他のマッパー形式（概要）
- **MSX メモリマッパー (RAM拡張)**: MSX2以降のRAM拡張で使われる4/16/64 KiBページ単位の切替方式。I/OポートFC–FFhでバンク指定。ROMマッパーとは独立。
- **HAL, Cross Blaim系**: 8 KiBページを0x6000/0x8000/0xA000/0xC000の各帯で切替えるが、ASCII/コナミとはレジスタアドレスが異なるため、特定ソフト専用になりがち。
- **Super Lode Runner方式**: 16 KiBページを0x6000で切替えるなど、単純な1レジスタ方式。互換性が低く、エミュレータ設定で個別指定するケースが多い。
- **分岐レイアウト/複合マッパー**: CD-ROM移植などでROM内に異なるマッパーが混在する例があり、ハード依存コードやスロット初期化ルーチンを併用する。

### マッパー選択時の注意点
- ROMを自作する場合、ターゲット環境(実機/エミュレータ)が指定マッパーを自動判別できるか確認する。
- バンク切替中に同一ページのコードを実行すると暴走するため、切替用スタブを固定ページかRAM上に置く。
- DOS上で動かす場合、他のデバイスやサウンド拡張が同じI/Oを使わないか確認する。

### エミュレータでのマッパー指定例
- **webMSX**: ROMをドラッグ&ドロップしたあと、`MENU -> Cartridge -> Mapper`から`Konami SCC`や`ASCII 8k`など目的のマッパーを選択する。MegaROMの場合は`Konami`/`Konami SCC`を指定すると自動で切替レジスタが有効になる。自動判定がうまくいかない場合は、ファイル名末尾に`[KONAMI-SCC]`や`[ASCII16]`など角かっこ付きのマッパー名を付与した状態で読み込むと強制指定できる。
- **openMSX**: 起動時に`openmsx -cart your.rom -cartmapper konami-scc`のように`-cartmapper`オプションで明示する。ASCII系なら`-cartmapper ascii8k`や`ascii16k`、コナミ系なら`konami`/`konami-scc`を指定。後からはコンソールで`set cartmapper_slot1 konami-scc`のように変更できる。

